diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/Makefile.in sed-4.2-src/Makefile.in
--- sed-4.2-orig/Makefile.in	2009-04-30 11:01:51.000000000 +0200
+++ sed-4.2-src/Makefile.in	2009-05-04 13:48:34.915040200 +0200
@@ -542,6 +542,7 @@ sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
 target_alias = @target_alias@
+top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/basicdefs.h sed-4.2-src/basicdefs.h
--- sed-4.2-orig/basicdefs.h	2009-04-27 12:14:51.000000000 +0200
+++ sed-4.2-src/basicdefs.h	2009-05-04 13:43:10.071290200 +0200
@@ -150,7 +150,7 @@ typedef unsigned long countT;
 #endif
 
 #undef ISPRINT
-#define ISPRINT(c) (ISASCII (c) && isprint (c))
+#define ISPRINT(c) (ISASCII (c) && isprint (c) && ((c) != '\t'))
 #define ISDIGIT(c) (ISASCII (c) && isdigit (c))
 #define ISALNUM(c) (ISASCII (c) && isalnum (c))
 #define ISALPHA(c) (ISASCII (c) && isalpha (c))
@@ -170,4 +170,26 @@ typedef unsigned long countT;
 # endif
 #endif
 
+#ifdef _WIN32
+
+#define	chmod	_chmod
+#define	fdopen	_fdopen
+#define	isatty	_isatty
+#define	mktemp	_mktemp
+#define	pclose	_pclose
+#define	popen	_popen
+#define	setmode	_setmode
+#define	unlink	_unlink
+
+#include <sys/stat.h>
+#define	stat		_stati64
+#define	off_t	__int64
+
+#ifdef __MINGW32__
+#include <stdio.h>
+#define ftell      ftello64
+#endif /* __MINGW32__ */
+
+#endif /* _WIN32 */
+
 #endif /*!BASICDEFS_H*/
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/config_h.in sed-4.2-src/config_h.in
--- sed-4.2-orig/config_h.in	2009-04-30 10:56:55.000000000 +0200
+++ sed-4.2-src/config_h.in	2009-05-04 13:51:15.180665000 +0200
@@ -570,11 +570,6 @@
 /* Number of bits in a file offset, on hosts where this is settable. */
 #undef _FILE_OFFSET_BITS
 
-/* Enable GNU extensions on systems that have them.  */
-#ifndef _GNU_SOURCE
-# undef _GNU_SOURCE
-#endif
-
 /* Define for large files, on AIX-style hosts. */
 #undef _LARGE_FILES
 
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/doc/Makefile.in sed-4.2-src/doc/Makefile.in
--- sed-4.2-orig/doc/Makefile.in	2009-04-30 10:52:10.000000000 +0200
+++ sed-4.2-src/doc/Makefile.in	2009-05-04 13:48:33.243165200 +0200
@@ -535,6 +535,7 @@ sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
 target_alias = @target_alias@
+top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 info_TEXINFOS = sed.texi
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/doc/sed.1 sed-4.2-src/doc/sed.1
--- sed-4.2-orig/doc/sed.1	2009-04-30 11:14:01.000000000 +0200
+++ sed-4.2-src/doc/sed.1	2009-06-04 23:08:17.281250000 +0200
@@ -1,9 +1,9 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.28.
-.TH SED "1" "April 2009" "sed version 4.2" "User Commands"
+.TH SED "1" "June 2009" "sed version 4.2" "User Commands"
 .SH NAME
 sed \- stream editor for filtering and transforming text
 .SH SYNOPSIS
-.B sed
+.B sed.exe
 [\fIOPTION\fR]... \fI{script-only-if-no-other-script} \fR[\fIinput-file\fR]...
 .SH DESCRIPTION
 .ds sd \fIsed\fP
@@ -19,6 +19,8 @@ input(s), and is consequently more effic
 But it is \*(sd's ability to filter text in a pipeline
 which particularly distinguishes it from other types of
 editors.
+.PP
+
 .HP
 \fB\-n\fR, \fB\-\-quiet\fR, \fB\-\-silent\fR
 .IP
@@ -32,14 +34,19 @@ add the script to the commands to be exe
 .IP
 add the contents of script-file to the commands to be executed
 .HP
-\fB\-\-follow\-symlinks\fR
-.IP
-follow symlinks when processing in place
-.HP
 \fB\-i[SUFFIX]\fR, \fB\-\-in\-place\fR[=\fISUFFIX\fR]
 .IP
 edit files in place (makes backup if extension supplied)
 .HP
+\fB\-b\fR, \fB\-\-binary\fR
+.IP
+open files in binary mode (CR+LFs are not processed specially)
+.HP
+\fB\-c\fR, \fB\-\-copy\fR
+.IP
+use copy instead of rename when shuffling files in \fB\-i\fR mode
+(avoids change of input file ownership)
+.HP
 \fB\-l\fR N, \fB\-\-line\-length\fR=\fIN\fR
 .IP
 specify the desired line-wrap length for the `l' command
@@ -68,11 +75,13 @@ display this help and exit
 \fB\-\-version\fR
 output version information and exit
 .PP
+
 If no \fB\-e\fR, \fB\-\-expression\fR, \fB\-f\fR, or \fB\-\-file\fR option is given, then the first
 non-option argument is taken as the sed script to interpret.  All
 remaining arguments are names of input files; if no input files are
 specified, then the standard input is read.
 .PP
+
 GNU sed home page: <http://www.gnu.org/software/sed/>.
 General help using GNU software: <http://www.gnu.org/gethelp/>.
 E-mail bug reports to: <bug-gnu-utils@gnu.org>.
@@ -372,7 +381,7 @@ Copyright \(co 2003 Free Software Founda
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE,
 to the extent permitted by law.
-.PP
+
 GNU sed home page: <http://www.gnu.org/software/sed/>.
 General help using GNU software: <http://www.gnu.org/gethelp/>.
 E-mail bug reports to: <bug-gnu-utils@gnu.org>.
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/lib/Makefile.in sed-4.2-src/lib/Makefile.in
--- sed-4.2-orig/lib/Makefile.in	2009-04-30 10:52:10.000000000 +0200
+++ sed-4.2-src/lib/Makefile.in	2009-05-04 13:48:33.790040200 +0200
@@ -552,6 +552,7 @@ sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
 target_alias = @target_alias@
+top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 AUTOMAKE_OPTIONS = 1.5 gnits
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/lib/regex_internal.h sed-4.2-src/lib/regex_internal.h
--- sed-4.2-orig/lib/regex_internal.h	2009-03-31 08:52:25.000000000 +0200
+++ sed-4.2-src/lib/regex_internal.h	2009-05-04 13:43:10.165040200 +0200
@@ -458,7 +458,15 @@ static unsigned int re_string_context_at
 #define re_string_skip_bytes(pstr,idx) ((pstr)->cur_idx += (idx))
 #define re_string_set_index(pstr,idx) ((pstr)->cur_idx = (idx))
 
+#ifdef HAVE_ALLOCA_H
 #include <alloca.h>
+#endif
+#ifdef HAVE_ALLOCA
+# ifdef _WIN32
+#  include <malloc.h>
+#  define alloca _alloca
+# endif
+#endif
 
 #ifndef _LIBC
 # if HAVE_ALLOCA
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/sed/Makefile.in sed-4.2-src/sed/Makefile.in
--- sed-4.2-orig/sed/Makefile.in	2009-04-30 10:52:11.000000000 +0200
+++ sed-4.2-src/sed/Makefile.in	2009-05-04 14:30:47.430665200 +0200
@@ -81,7 +81,7 @@ am__installdirs = "$(DESTDIR)$(bindir)"
 binPROGRAMS_INSTALL = $(INSTALL_PROGRAM)
 PROGRAMS = $(bin_PROGRAMS)
 am_sed_OBJECTS = sed.$(OBJEXT) compile.$(OBJEXT) execute.$(OBJEXT) \
-	regexp.$(OBJEXT) fmt.$(OBJEXT) mbcs.$(OBJEXT) utils.$(OBJEXT)
+	regexp.$(OBJEXT) fmt.$(OBJEXT) mbcs.$(OBJEXT) utils.$(OBJEXT) sed-res.$(OBJEXT)
 sed_OBJECTS = $(am_sed_OBJECTS)
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
 depcomp = $(SHELL) $(top_srcdir)/build-aux/depcomp
@@ -467,6 +467,9 @@ UNISTD_H_HAVE_WINSOCK2_H = @UNISTD_H_HAV
 USE_ACL = @USE_ACL@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+MAJOR = $(shell echo $(VERSION) | sed -e "s/\..*$$//")
+MINOR = $(shell echo $(VERSION) | sed -e "s/^[^\.]*\.0*\([0-9]\+\).*$$/\1/")
+LDFLAGS += -Wl,--major-image-version=$(MAJOR) -Wl,--minor-image-version=$(MINOR)
 VOID_UNSETENV = @VOID_UNSETENV@
 WCHAR_H = @WCHAR_H@
 WCHAR_T_SUFFIX = @WCHAR_T_SUFFIX@
@@ -527,6 +530,7 @@ sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
 target_alias = @target_alias@
+top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 sed_SOURCES = sed.c compile.c execute.c regexp.c fmt.c mbcs.c utils.c
@@ -539,7 +543,7 @@ sed_DEPENDENCIES = ../lib/libsed.a
 all: all-am
 
 .SUFFIXES:
-.SUFFIXES: .c .o .obj
+.SUFFIXES: .c .o .obj .rc .exe
 $(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
@@ -626,6 +630,12 @@ distclean-compile:
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sed.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/utils.Po@am__quote@
 
+# Rule to make compiled resource (Windows)
+resdir = @top_builddir@/resource
+vpath %-res.rc $(resdir)
+.rc.o:
+	windres --include-dir $(resdir) -i $< -o $@
+
 .c.o:
 @am__fastdepCC_TRUE@	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/sed/execute.c sed-4.2-src/sed/execute.c
--- sed-4.2-orig/sed/execute.c	2009-04-30 10:43:03.000000000 +0200
+++ sed-4.2-src/sed/execute.c	2009-05-31 17:57:51.765625000 +0200
@@ -689,7 +689,6 @@ open_next_file(name, input)
   struct input *input;
 {
   buffer.length = 0;
-
   if (name[0] == '-' && name[1] == '\0' && !in_place_extension)
     {
       clearerr(stdin);	/* clear any stale EOF indication */
@@ -767,17 +766,23 @@ closedown(input)
     {
       const char *target_name;
       ck_fclose (output_file.fp);
+      if (follow_symlinks)
+        target_name = ck_strdup(follow_symlink(input->in_file_name));
+      else
+        target_name = ck_strdup(input->in_file_name);
 
-      target_name = input->in_file_name;
       if (strcmp(in_place_extension, "*") != 0)
         {
           char *backup_file_name = get_backup_file_name(target_name);
-	  ck_rename (target_name, backup_file_name, input->out_file_name);
+		(copy_instead_of_rename ? ck_fcmove : ck_rename)
+			(target_name, backup_file_name, input->out_file_name);
           free (backup_file_name);
 	}
 
-      ck_rename (input->out_file_name, target_name, input->out_file_name);
+	(copy_instead_of_rename ? ck_fcmove : ck_rename)
+		(input->out_file_name, target_name, input->out_file_name);
       free (input->out_file_name);
+	 free (target_name);
     }
 
   ck_fclose (input->fp);
@@ -1244,7 +1249,7 @@ do_subst(sub)
       line_reset(&s_accum, NULL);
       
       str_append (&line, "", 1);
-      pipe_fp = popen(line.active, "r");
+      pipe_fp = popen(line.active, read_mode);
       
       if (pipe_fp != NULL) 
 	{
@@ -1406,12 +1411,12 @@ execute_program(vec, input)
 	      if (!cmd_length)
 		{
 		  str_append (&line, "", 1);
-		  pipe_fp = popen(line.active, "r");
+		  pipe_fp = popen(line.active, read_mode);
 		} 
 	      else
 		{
 		  cur_cmd->x.cmd_txt.text[cmd_length - 1] = 0;
-		  pipe_fp = popen(cur_cmd->x.cmd_txt.text, "r");
+		  pipe_fp = popen(cur_cmd->x.cmd_txt.text, read_mode);
                   output_missing_newline(&output_file);
 		}
 
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/sed/sed.c sed-4.2-src/sed/sed.c
--- sed-4.2-orig/sed/sed.c	2009-04-27 12:09:43.000000000 +0200
+++ sed-4.2-src/sed/sed.c	2009-06-04 23:07:49.250000000 +0200
@@ -46,6 +46,8 @@
 #endif
 #include "getopt.h"
 
+#include <fcntl.h> /* for O_BINARY and O_TEXT */
+
 #ifndef BOOTSTRAP
 #ifndef HAVE_STDLIB_H
  extern char *getenv P_((const char *));
@@ -80,6 +82,10 @@ char *in_place_extension = NULL;
 /* The mode to use to read files, either "rt" or "rb".  */
 char *read_mode = "rt";
 
+/* Do we use copy or rename when in in-place edit mode? (boolean
+   value, non-zero for copy, zero for rename).*/
+int copy_instead_of_rename = 0;
+
 /* Do we need to be pedantically POSIX compliant? */
 enum posixicity_types posixicity;
 
@@ -141,6 +147,9 @@ Usage: %s [OPTION]... {script-only-if-no
   fprintf(out, _("  -b, --binary\n\
                  open files in binary mode (CR+LFs are not processed specially)\n"));
 #endif
+  fprintf(out, _("  -c, --copy\n\
+                 use copy instead of rename when shuffling files in -i mode\n\
+		 (avoids change of input file ownership)\n"));
   fprintf(out, _("  -l N, --line-length=N\n\
                  specify the desired line-wrap length for the `l' command\n"));
   fprintf(out, _("  --posix\n\
@@ -158,6 +167,7 @@ Usage: %s [OPTION]... {script-only-if-no
                  the output buffers more often\n"));
   fprintf(out, _("      --help     display this help and exit\n"));
   fprintf(out, _("      --version  output version information and exit\n"));
+
   fprintf(out, _("\n\
 If no -e, --expression, -f, or --file option is given, then the first\n\
 non-option argument is taken as the sed script to interpret.  All\n\
@@ -176,9 +186,9 @@ main(argc, argv)
   char **argv;
 {
 #ifdef REG_PERL
-#define SHORTOPTS "bsnrRuEe:f:l:i::V:"
+#define SHORTOPTS "bcsnrRuETe:f:l:i::V:"
 #else
-#define SHORTOPTS "bsnruEe:f:l:i::V:"
+#define SHORTOPTS "bcsnruETe:f:l:i::V:"
 #endif
 
   static struct option longopts[] = {
@@ -190,6 +200,7 @@ main(argc, argv)
     {"expression", 1, NULL, 'e'},
     {"file", 1, NULL, 'f'},
     {"in-place", 2, NULL, 'i'},
+    {"copy", 0, NULL, 'c'},
     {"line-length", 1, NULL, 'l'},
     {"quiet", 0, NULL, 'n'},
     {"posix", 0, NULL, 'p'},
@@ -201,6 +212,9 @@ main(argc, argv)
 #ifdef ENABLE_FOLLOW_SYMLINKS
     {"follow-symlinks", 0, NULL, 'F'},
 #endif
+#ifdef _WIN32
+    {"textmode", 0, NULL, 'T'},
+#endif
     {NULL, 0, NULL, 0}
   };
 
@@ -240,6 +254,13 @@ main(argc, argv)
     }
 
   myname = *argv;
+#ifdef _WIN32
+  { char *p;
+    p = strrchr (myname, '\\');
+    if (p)
+      myname = ++p;
+  }
+#endif /* _WIN32 */
   while ((opt = getopt_long(argc, argv, SHORTOPTS, longopts, NULL)) != EOF)
     {
       switch (opt)
@@ -257,7 +278,9 @@ main(argc, argv)
 	case 'F':
 	  follow_symlinks = true;
 	  break;
-
+	case 'c':
+	  copy_instead_of_rename = true;
+	  break;
 	case 'i':
 	  separate_files = true;
 	  if (optarg == NULL)
@@ -273,6 +296,9 @@ main(argc, argv)
 	      in_place_extension[0] = '*';
 	      strcpy (in_place_extension + 1, optarg);
 	    }
+#ifdef _WIN32
+	  copy_instead_of_rename = true;
+#endif /* _WIN32 */
 
 	  break;
 
@@ -329,6 +355,8 @@ to the extent permitted by law.\n\
 
 	  ck_fclose (NULL);
 	  exit (0);
+	case 'T':
+	  break;
 	case 'h':
 	  usage(0);
 	default:
@@ -336,6 +364,19 @@ to the extent permitted by law.\n\
 	}
     }
 
+  if (copy_instead_of_rename && in_place_extension == NULL)
+    {
+      fprintf (stderr, _("Error: -c used without -i.\n"));
+      usage(4);
+    }
+
+   if (!strcmp(read_mode,"rb")) {
+        if (!isatty (STDOUT_FILENO))
+             setmode (STDOUT_FILENO, O_BINARY);
+        if (!isatty (STDIN_FILENO))
+             setmode (STDIN_FILENO, O_BINARY);
+   }
+
   if (!the_program)
     {
       if (optind < argc)
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/sed/sed.h sed-4.2-src/sed/sed.h
--- sed-4.2-orig/sed/sed.h	2009-04-27 12:14:51.000000000 +0200
+++ sed-4.2-src/sed/sed.h	2009-05-04 15:56:41.024415200 +0200
@@ -232,6 +232,10 @@ extern countT lcmd_out_line_len;
 /* How do we edit files in-place? (we don't if NULL) */
 extern char *in_place_extension;
 
+/* Do we use copy or rename when in in-place edit mode? (boolean
+   value, non-zero for copy, zero for rename).*/
+extern int copy_instead_of_rename;
+
 /* The mode to use to read files, either "rt" or "rb".  */
 extern char *read_mode;
 
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/sed/utils.c sed-4.2-src/sed/utils.c
--- sed-4.2-orig/sed/utils.c	2009-04-30 10:43:47.000000000 +0200
+++ sed-4.2-src/sed/utils.c	2009-06-04 23:23:38.812500000 +0200
@@ -204,13 +204,18 @@ ck_mkstemp (p_filename, tmpdir, base)
   if (tmpdir == NULL)
     tmpdir = getenv("TMPDIR");
   if (tmpdir == NULL)
-    {
       tmpdir = getenv("TMP");
       if (tmpdir == NULL)
+    tmpdir = getenv("TEMP");
+  if (tmpdir == NULL) {
 #ifdef P_tmpdir
 	tmpdir = P_tmpdir;
 #else
+#ifdef _WIN32
+    tmpdir = ".";
+#else
 	tmpdir = "/tmp";
+#endif /* _WIN32 */
 #endif
     }
 
@@ -412,16 +417,111 @@ follow_symlink(const char *fname)
 #endif /* ENABLE_FOLLOW_SYMLINKS */
 }
 
+/* Panic on failing unlink */
+void
+ck_unlink (name)
+  const char *name;
+{
+  if (unlink (name) == -1)
+    panic (_("cannot remove %s: %s"), name, strerror (errno));
+}
+
+/* Attempt to unlink denoted file if operation rd failed. */
+static int
+_unlink_if_fail (rd, unlink_if_fail)
+  int rd;
+  const char *unlink_if_fail;
+{
+  if (rd == -1 && unlink_if_fail)
+    {
+      int save_errno = errno;
+      ck_unlink (unlink_if_fail);
+      errno = save_errno;
+    }
+
+  return rd != -1;
+}
+
+/* Copy contents between files. */
+static int
+_copy (from, to)
+  const char *from, *to;
+{
+  int retval = 0;
+#ifdef _WIN32
+#include <errno.h>
+#include <windows.h>
+  int res;
+  res = CopyFile (from, to, FALSE);
+  if (res == 0) {
+	errno = EINVAL;
+	retval = -1;
+  } else
+     retval = 0;
+#else
+  static size_t bufsize = 1024;
+  FILE *infile, *outfile;
+  char * buf;
+
+  errno = 0;
+
+  infile = fopen (from, (binary_files ? "rb" : "r"));
+  if (infile == NULL)
+    return -1;
+
+  outfile = fopen (to, (binary_files ? "wb" : "w"));
+  if (outfile == NULL)
+    {
+      fclose (infile);
+      return -1;
+    }
+
+  buf = alloca (bufsize);
+  while (1)
+    {
+      size_t bytes_in = fread (buf, 1, bufsize, infile);
+      size_t bytes_out;
+      if (bytes_in == 0)
+	{
+	  if (ferror (infile))
+	    retval = -1;
+	  break;
+	}
+
+      bytes_out = fwrite (buf, 1, bytes_in, outfile);
+      if (bytes_out != bytes_in)
+	{
+	  retval = -1;
+	  break;
+	}
+    }
+
+  fclose (outfile);
+  fclose (infile);
+#endif
+  return retval;
+}
+
 /* Panic on failing rename */
 void
 ck_rename (from, to, unlink_if_fail)
   const char *from, *to;
   const char *unlink_if_fail;
 {
+fprintf (stderr, "from = %s  to = %s unlink_if_fail = %s\n", from, to, unlink_if_fail);
+#ifdef _WIN32
+  if (_access (to, 0) != -1) { /* to exists */
+	if (_chmod (to, _S_IREAD | _S_IWRITE) == -1)
+        panic (_("cannot chmod %s: %s"), to, strerror (errno));
+	if (_unlink (to) == -1)
+        panic (_("cannot unlink %s: %s"), to, strerror (errno));
+}
+#endif
   int rd = rename (from, to);
   if (rd != -1)
     return;
 
+  
   if (unlink_if_fail)
     {
       int save_errno = errno;
@@ -435,10 +535,28 @@ ck_rename (from, to, unlink_if_fail)
       errno = save_errno;
     }
 
-  panic (_("cannot rename %s: %s"), from, strerror (errno));
+  panic (_("cannot rename %s to %s: %s"), from, to, strerror (errno));
 }
 
+/* Attempt to copy file contents between the files. */
+void
+ck_fcmove (from, to, unlink_if_fail)
+  const char *from, *to;
+  const char *unlink_if_fail;
+{
+  if (!_unlink_if_fail (_copy (from, to), unlink_if_fail))
+    panic (_("cannot copy %s to %s: %s"), from, to, strerror (errno));
+}
 
+/* Copy contents between files, and then unlink the source. */
+void
+ck_fcopy (from, to, unlink_if_fail)
+  const char *from, *to;
+  const char *unlink_if_fail;
+{
+  ck_fcmove (from, to, unlink_if_fail);
+  ck_unlink (from);
+}
 
 
 /* Panic on failing malloc */
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/sed/utils.h sed-4.2-src/sed/utils.h
--- sed-4.2-orig/sed/utils.h	2009-04-30 10:43:59.000000000 +0200
+++ sed-4.2-src/sed/utils.h	2009-05-31 17:39:47.921875000 +0200
@@ -32,6 +32,8 @@ const char *follow_symlink P_((const cha
 size_t ck_getline P_((char **text, size_t *buflen, FILE *stream));
 FILE * ck_mkstemp P_((char **p_filename, char *tmpdir, char *base));
 void ck_rename P_((const char *from, const char *to, const char *unlink_if_fail));
+void ck_fcopy P_((const char *from, const char *to, const char *unlink_if_fail));
+void ck_fcmove P_((const char *from, const char *to, const char *unlink_if_fail));
 
 VOID *ck_malloc P_((size_t size));
 VOID *xmalloc P_((size_t size));
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/testsuite/Makefile.in sed-4.2-src/testsuite/Makefile.in
--- sed-4.2-orig/testsuite/Makefile.in	2009-04-30 10:52:11.000000000 +0200
+++ sed-4.2-src/testsuite/Makefile.in	2009-05-04 13:48:34.571290200 +0200
@@ -614,6 +614,7 @@ sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
 target_alias = @target_alias@
+top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 CLEANFILES = tmp* core *.core $(EXTRA_PROGRAMS) *.*out *.log eval.in2
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/testsuite/bsd.sh sed-4.2-src/testsuite/bsd.sh
--- sed-4.2-orig/testsuite/bsd.sh	2008-04-24 16:24:11.000000000 +0200
+++ sed-4.2-src/testsuite/bsd.sh	2009-05-04 13:43:10.305665200 +0200
@@ -147,8 +147,8 @@ test_addr()
 	mark '2.3' ; $SED -n -e '$p' lines1
 	mark '2.4' ; $SED -n -e '$p' lines1 lines2
 	mark '2.5' ; $SED -n -e '$a\
-hello' /dev/null
-	mark '2.6' ; $SED -n -e '$p' lines1 /dev/null lines2
+hello' NUL
+	mark '2.6' ; $SED -n -e '$p' lines1 NUL lines2
 	# Should not print anything
 	mark '2.7' ; $SED -n -e '20p' lines1
 	# Disabled because it is undefined behavior
@@ -345,7 +345,8 @@ test_print()
 	echo Testing print and file routines
 	awk 'END {for (i = 1; i < 256; i++) printf("%c", i);print "\n"}' \
 		</dev/null >lines3
-	mark '7.1' ; $SED -n l lines3
+	cp -fp lines3 lines3.awk
+	mark '7.1' ; $SED -B -n l lines3
 	mark '7.2' ; $SED -e '/l2_/=' lines1 lines2
 	rm -f lines4
 	mark '7.3' ; $SED -e '3,12w lines4' lines1
@@ -353,7 +354,7 @@ test_print()
 	cat lines4
 	mark '7.4' ; $SED -e '4r lines2' lines1
 	mark '7.5' ; $SED -e '5r /dev/dds' lines1
-	mark '7.6' ; $SED -e '6r /dev/null' lines1
+	mark '7.6' ; $SED -e '6r NUL' lines1
 	# mark '7.7'
 	# sed '200q' $DICT | sed 's$.*$s/^/&/w tmpdir/&$' >script1
 	# rm -rf tmpdir
@@ -364,7 +365,7 @@ test_print()
 	mark '7.8'
 	echo line1 > lines3
 	echo "" >> lines3
-	$SED -n -e '$p' lines3 /dev/null
+	$SED -n -e '$p' lines3 NUL
 }
 
 test_subst()
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/testsuite/bug-regex15.c sed-4.2-src/testsuite/bug-regex15.c
--- sed-4.2-orig/testsuite/bug-regex15.c	2009-04-27 12:14:51.000000000 +0200
+++ sed-4.2-src/testsuite/bug-regex15.c	2009-05-04 13:43:10.321290200 +0200
@@ -6,7 +6,9 @@
 
 #include <sys/types.h>
 #include <sys/time.h>
+#ifdef HAVE_SYS_RESOURCE_H
 #include <sys/resource.h>
+#endif
 #include <regex.h>
 #include <stdio.h>
 #include <stdlib.h>
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/testsuite/eval.good sed-4.2-src/testsuite/eval.good
--- sed-4.2-orig/testsuite/eval.good	2008-01-09 17:20:38.000000000 +0100
+++ sed-4.2-src/testsuite/eval.good	2009-05-04 13:43:10.321290200 +0200
@@ -31,10 +31,10 @@ cpu
 Doing some more tests -----------------------
 17380: 2 2 5 11 79
 ---
-../sed/sed 1q eval.in2
+..\sed\sed.exe 1q eval.in2
 ---
 17380: 2 2 5 11 79
 ---
-../sed/sed 1q eval.in2
+..\sed\sed.exe 1q eval.in2
 ---
-../sed/sed 1q eval.in2
+..\sed\sed.exe 1q eval.in2
diff -ipuwr --binary --strip-trailing-cr -x '*.bak' -x '*.orig' -x '*.rej' -x '*.new' -x '*~' -x debian -x '*.po' -x '*.pot' sed-4.2-orig/testsuite/eval.sed sed-4.2-src/testsuite/eval.sed
--- sed-4.2-orig/testsuite/eval.sed	2008-01-09 17:20:38.000000000 +0100
+++ sed-4.2-src/testsuite/eval.sed	2009-05-04 13:43:10.336915200 +0200
@@ -2,7 +2,7 @@
 
 	#Try eval command
 	/cpu/!b2
-	e../sed/sed 1q eval.in2
+	e..\\sed\\sed.exe 1q eval.in2
 
 :2
 p
@@ -10,7 +10,7 @@ i---
 h
 
 	#Try eval option
-	s,.* *cpu *,../sed/sed 1q eval.in2; echo "&",e
+	s,.* *cpu *,..\\sed\\sed.exe 1q eval.in2; echo "&",e
 
 :3
 p
@@ -19,7 +19,7 @@ i---
 
 	h
 	#Try eval option with print
-	s,.* *cpu.*,../sed/sed 1q eval.in2,ep
+	s,.* *cpu.*,..\\sed\\sed.exe 1q eval.in2,ep
 	g
 
 
@@ -31,11 +31,11 @@ $!d
 
 #Do some more tests
 s/.*/Doing some more tests -----------------------/p
-s,.*,../sed/sed 1q eval.in2,ep
+s,.*,..\\sed\\sed.exe 1q eval.in2,ep
 i---
-s,.*,../sed/sed 1q eval.in2,pe
+s,.*,..\\sed\\sed.exe 1q eval.in2,pe
 i---
-s,.*,../sed/sed 1q eval.in2,
+s,.*,..\\sed\\sed.exe 1q eval.in2,
 h
 e
 p
